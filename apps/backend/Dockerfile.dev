FROM node:18-alpine

WORKDIR /app

# Install pnpm
RUN npm install -g pnpm

# Copy root workspace files
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml* ./

# Copy required packages
COPY packages/shared ./packages/shared/
COPY packages/tsconfig ./packages/tsconfig/
COPY packages/database ./packages/database/

# Copy backend app
COPY apps/backend ./apps/backend/

# Install all dependencies
RUN pnpm install --frozen-lockfile

# Build shared packages first
RUN pnpm --filter shared build
RUN pnpm --filter database build

# Set working directory to backend app
WORKDIR /app/apps/backend

EXPOSE 3000

CMD ["pnpm", "dev"]